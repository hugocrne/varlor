openapi: 3.0.3
info:
  title: Varlor Product API
  version: 1.0.0
  description: |
    Documentation OpenAPI 3.0 de l'API Varlor exposant les fonctionnalités d'authentification,
    de gestion des clients, des utilisateurs, des préférences utilisateur et des sessions.
    Toutes les routes (hors authentification) nécessitent un jeton JWT valide transmis via l'en-tête
    `Authorization: Bearer <token>`. Les réponses d'erreur suivent la structure RFC 7807 (`ProblemDetails`)
    et reflètent les exceptions métier (ValidationException, NotFoundException, DuplicateResourceException,
    UnauthorizedException, DatabaseException).
servers:
  - url: https://localhost:7127
    description: Serveur HTTPS de développement
  - url: http://localhost:5091
    description: Serveur HTTP de développement
tags:
  - name: Auth
    description: Authentification et gestion du cycle de vie des jetons JWT.
  - name: Client
    description: Gestion CRUD des clients Varlor avec suppression logique.
  - name: User
    description: Gestion CRUD des utilisateurs, rôles et statuts.
  - name: UserPreference
    description: Gestion des préférences associées aux utilisateurs.
  - name: UserSession
    description: Gestion et audit des sessions et refresh tokens.
paths:
  /api/Auth/login:
    post:
      tags:
        - Auth
      summary: Authentifier un utilisateur et créer une session
      description: >
        Authentifie un utilisateur actif à l'aide d'un couple email/mot de passe puis émet un jeton d'accès
        et un refresh token. Cette opération est publique et ne requiert pas de jeton Bearer.
      operationId: Auth_Login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequestDto'
            example:
              Email: owner@example.com
              Password: MotDePasse#2025
      responses:
        '200':
          description: Jetons générés avec succès.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponseDto'
              example:
                AccessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                RefreshToken: Z0FBQUFBQmx...
                ExpiresAt: '2025-11-10T10:45:00Z'
                RefreshExpiresAt: '2025-11-24T10:30:00Z'
        '400':
          $ref: '#/components/responses/ValidationProblem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/Auth/refresh:
    post:
      tags:
        - Auth
      summary: Rafraîchir un couple de jetons JWT
      description: >
        Échange un refresh token valide contre un nouveau couple jeton d'accès / refresh et
        révoque l'ancien refresh token. L'opération ne requiert pas d'en-tête Authorization mais
        le refresh token doit être actif, non révoqué et appartenir à un utilisateur actif.
      operationId: Auth_Refresh
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequestDto'
            example:
              RefreshToken: Z0FBQUFBQmxHV0Z3cTR...
      responses:
        '200':
          description: Nouveau couple de jetons émis.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPairResponseDto'
              example:
                AccessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                RefreshToken: m3JBQUFBZnhhV2svZ1V...
                ExpiresAt: '2025-11-10T10:45:00Z'
                RefreshExpiresAt: '2025-11-24T10:30:00Z'
        '400':
          $ref: '#/components/responses/ValidationProblem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/Auth/logout:
    post:
      tags:
        - Auth
      summary: Révoquer un refresh token
      description: >
        Révoque le refresh token fourni. Peut optionnellement révoquer toutes les sessions actives
        de l'utilisateur associé. Opération publique : le refresh token sert d'authentification.
      operationId: Auth_Logout
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequestDto'
            example:
              RefreshToken: Z0FBQUFBQlFUV2ltV2c...
              RevokeAllSessions: true
      responses:
        '204':
          description: Refresh token révoqué ou déjà inexistant.
        '400':
          $ref: '#/components/responses/ValidationProblem'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/Client:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
    get:
      tags:
        - Client
      summary: Lister les clients actifs
      description: >
        Retourne la liste des clients dont la suppression logique (`DeletedAt`) est nulle.
        Nécessite un jeton Bearer avec un rôle OWNER, ADMIN ou SERVICE.
      operationId: Client_ListClients
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des clients actifs.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientDto'
              example:
                - Id: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                  Name: Varlor Labs
                  Type: COMPANY
                  Status: ACTIVE
                  CreatedAt: '2025-10-10T09:30:00Z'
                  UpdatedAt: '2025-11-01T11:45:12Z'
                  DeletedAt: null
                - Id: 99132b35-0d9a-4855-9222-7f04bdb21b6c
                  Name: Jane Doe
                  Type: INDIVIDUAL
                  Status: ACTIVE
                  CreatedAt: '2025-10-12T08:00:00Z'
                  UpdatedAt: '2025-10-20T07:15:05Z'
                  DeletedAt: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags:
        - Client
      summary: Créer un client
      description: >
        Crée un client et renvoie sa représentation. Nécessite un jeton Bearer avec un rôle OWNER,
        ADMIN ou SERVICE. L'en-tête Location de la réponse pointe vers la ressource créée.
      operationId: Client_CreateClient
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientDto'
            example:
              Name: Contoso Retail
              Type: COMPANY
              Status: ACTIVE
      responses:
        '201':
          description: Client créé.
          headers:
            Location:
              description: URL du client nouvellement créé.
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientDto'
              example:
                Id: 5c2ddf0b-9a2e-4c19-9f19-8f6f8487308a
                Name: Contoso Retail
                Type: COMPANY
                Status: ACTIVE
                CreatedAt: '2025-11-10T10:30:00Z'
                UpdatedAt: '2025-11-10T10:30:00Z'
                DeletedAt: null
        '400':
          $ref: '#/components/responses/ValidationProblem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/Client/{id}:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
      - name: id
        in: path
        required: true
        description: Identifiant du client.
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Client
      summary: Consulter un client
      description: >
        Retourne la représentation d'un client actif à partir de son identifiant.
        Nécessite un jeton Bearer avec rôle OWNER, ADMIN ou SERVICE.
      operationId: Client_GetClient
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Client trouvé.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientDto'
              example:
                Id: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                Name: Varlor Labs
                Type: COMPANY
                Status: ACTIVE
                CreatedAt: '2025-10-10T09:30:00Z'
                UpdatedAt: '2025-11-01T11:45:12Z'
                DeletedAt: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    patch:
      tags:
        - Client
      summary: Mettre à jour partiellement un client
      description: >
        Met à jour les propriétés d'un client actif. Les champs omis ne sont pas modifiés.
        Nécessite un jeton Bearer avec rôle OWNER, ADMIN ou SERVICE.
      operationId: Client_UpdateClient
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientDto'
            example:
              Name: Varlor Ventures
              Status: SUSPENDED
      responses:
        '200':
          description: Client mis à jour.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientDto'
              example:
                Id: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                Name: Varlor Ventures
                Type: COMPANY
                Status: SUSPENDED
                CreatedAt: '2025-10-10T09:30:00Z'
                UpdatedAt: '2025-11-10T11:00:00Z'
                DeletedAt: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags:
        - Client
      summary: Supprimer logiquement un client
      description: >
        Marque un client comme inactif (`Status = INACTIVE`) et renseigne `DeletedAt`.
        Nécessite un jeton Bearer avec rôle OWNER, ADMIN ou SERVICE.
      operationId: Client_DeleteClient
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Client supprimé logiquement.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/User:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
    get:
      tags:
        - User
      summary: Lister les utilisateurs actifs
      description: >
        Retourne les utilisateurs non supprimés (`DeletedAt = null`). Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: User_ListUsers
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des utilisateurs actifs.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserDto'
              example:
                - Id: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                  ClientId: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                  Email: owner@example.com
                  FirstName: Olivia
                  LastName: Martin
                  Role: OWNER
                  Status: ACTIVE
                  LastLoginAt: '2025-11-09T21:15:22Z'
                  CreatedAt: '2025-10-01T08:00:00Z'
                  UpdatedAt: '2025-11-09T21:15:22Z'
                  DeletedAt: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags:
        - User
      summary: Créer un utilisateur
      description: >
        Crée un utilisateur actif après validation de l'existence du client associé. Accessible aux rôles OWNER,
        ADMIN et MEMBER.
      operationId: User_CreateUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserDto'
            example:
              ClientId: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
              Email: admin@example.com
              PasswordHash: MotDePasseSecurise#2025
              FirstName: Alice
              LastName: Dupont
              Role: ADMIN
              Status: ACTIVE
      responses:
        '201':
          description: Utilisateur créé.
          headers:
            Location:
              description: URL de l'utilisateur nouvellement créé.
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDto'
              example:
                Id: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                ClientId: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                Email: admin@example.com
                FirstName: Alice
                LastName: Dupont
                Role: ADMIN
                Status: ACTIVE
                LastLoginAt: null
                CreatedAt: '2025-11-10T10:30:00Z'
                UpdatedAt: '2025-11-10T10:30:00Z'
                DeletedAt: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/User/{id}:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
      - name: id
        in: path
        required: true
        description: Identifiant de l'utilisateur.
        schema:
          type: string
          format: uuid
    get:
      tags:
        - User
      summary: Consulter un utilisateur
      description: >
        Retourne un utilisateur actif à partir de son identifiant. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: User_GetUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Utilisateur trouvé.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDto'
              example:
                Id: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                ClientId: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                Email: admin@example.com
                FirstName: Alice
                LastName: Dupont
                Role: ADMIN
                Status: ACTIVE
                LastLoginAt: '2025-11-09T21:15:22Z'
                CreatedAt: '2025-10-01T08:00:00Z'
                UpdatedAt: '2025-11-09T21:15:22Z'
                DeletedAt: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    patch:
      tags:
        - User
      summary: Mettre à jour partiellement un utilisateur
      description: >
        Met à jour un utilisateur actif. Le mot de passe est re-haché si fourni. Accessible aux rôles OWNER,
        ADMIN et MEMBER.
      operationId: User_UpdateUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserDto'
            example:
              Email: admin+support@example.com
              FirstName: Alicia
              Role: SERVICE
              Status: ACTIVE
      responses:
        '200':
          description: Utilisateur mis à jour.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDto'
              example:
                Id: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                ClientId: 7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
                Email: admin+support@example.com
                FirstName: Alicia
                LastName: Dupont
                Role: SERVICE
                Status: ACTIVE
                LastLoginAt: '2025-11-10T08:00:00Z'
                CreatedAt: '2025-10-01T08:00:00Z'
                UpdatedAt: '2025-11-10T10:45:00Z'
                DeletedAt: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags:
        - User
      summary: Supprimer logiquement un utilisateur
      description: >
        Marque un utilisateur comme inactif en renseignant `DeletedAt`. Accessible aux rôles OWNER, ADMIN et MEMBER.
      operationId: User_DeleteUser
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Utilisateur supprimé logiquement.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/UserPreference:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
    get:
      tags:
        - UserPreference
      summary: Lister les préférences utilisateur
      description: >
        Retourne les préférences triées par date de création. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserPreference_ListPreferences
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Préférences utilisateur.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPreferenceDto'
              example:
                - Id: c9c8bf45-8b1a-4b23-b6b1-a23d719d0352
                  UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                  Theme: DARK
                  Language: fr-FR
                  NotificationsEnabled: true
                  CreatedAt: '2025-10-02T09:00:00Z'
                  UpdatedAt: '2025-11-05T12:15:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags:
        - UserPreference
      summary: Créer des préférences pour un utilisateur
      description: >
        Crée une préférence unique par utilisateur après vérification de l'existence de l'utilisateur.
        Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserPreference_CreatePreference
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserPreferenceDto'
            example:
              UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
              Theme: LIGHT
              Language: en-US
              NotificationsEnabled: false
      responses:
        '201':
          description: Préférence créée.
          headers:
            Location:
              description: URL de la préférence créée.
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferenceDto'
              example:
                Id: c9c8bf45-8b1a-4b23-b6b1-a23d719d0352
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                Theme: LIGHT
                Language: en-US
                NotificationsEnabled: false
                CreatedAt: '2025-11-10T10:30:00Z'
                UpdatedAt: '2025-11-10T10:30:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/UserPreference/{id}:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
      - name: id
        in: path
        required: true
        description: Identifiant de la préférence.
        schema:
          type: string
          format: uuid
    get:
      tags:
        - UserPreference
      summary: Consulter une préférence utilisateur
      description: >
        Retourne la préférence correspondant à l'identifiant fourni.
      operationId: UserPreference_GetPreference
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Préférence trouvée.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferenceDto'
              example:
                Id: c9c8bf45-8b1a-4b23-b6b1-a23d719d0352
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                Theme: DARK
                Language: fr-FR
                NotificationsEnabled: true
                CreatedAt: '2025-10-02T09:00:00Z'
                UpdatedAt: '2025-11-05T12:15:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    patch:
      tags:
        - UserPreference
      summary: Mettre à jour partiellement une préférence
      description: >
        Modifie les attributs d'une préférence existante. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserPreference_UpdatePreference
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserPreferenceDto'
            example:
              Theme: SYSTEM
              NotificationsEnabled: true
      responses:
        '200':
          description: Préférence mise à jour.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferenceDto'
              example:
                Id: c9c8bf45-8b1a-4b23-b6b1-a23d719d0352
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                Theme: SYSTEM
                Language: fr-FR
                NotificationsEnabled: true
                CreatedAt: '2025-10-02T09:00:00Z'
                UpdatedAt: '2025-11-10T10:45:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags:
        - UserPreference
      summary: Supprimer une préférence utilisateur
      description: >
        Supprime définitivement la préférence spécifiée.
      operationId: UserPreference_DeletePreference
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Préférence supprimée.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/UserSession:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
    get:
      tags:
        - UserSession
      summary: Lister les sessions utilisateur
      description: >
        Retourne les sessions triées par date de création décroissante. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserSession_ListSessions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Sessions utilisateur.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserSessionDto'
              example:
                - Id: 4c0e1a77-00a9-45e0-89d2-7a23798b5df5
                  UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                  TokenId: 6d5ac8c5d9bb4c9cb2fd8b8f2d9f9c30
                  ReplacedByTokenId: null
                  IpAddress: 192.168.0.24
                  UserAgent: Mozilla/5.0 (Macintosh)
                  CreatedAt: '2025-11-09T21:15:22Z'
                  ExpiresAt: '2025-11-23T21:15:22Z'
                  RevokedAt: null
                  RevocationReason: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags:
        - UserSession
      summary: Créer une session utilisateur
      description: >
        Crée manuellement une session utilisateur. Vérifie l'unicité de `TokenId` et `TokenHash` ainsi que
        l'existence de l'utilisateur. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserSession_CreateSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserSessionDto'
            example:
              UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
              TokenId: 6d5ac8c5d9bb4c9cb2fd8b8f2d9f9c30
              TokenHash: 8aacffae-4a03-4338-95d0-5a3cbd9c65f7
              IpAddress: 192.168.0.24
              UserAgent: Mozilla/5.0 (Macintosh)
              ExpiresAt: '2025-11-23T21:15:22Z'
      responses:
        '201':
          description: Session créée.
          headers:
            Location:
              description: URL de la session créée.
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSessionDto'
              example:
                Id: 4c0e1a77-00a9-45e0-89d2-7a23798b5df5
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                TokenId: 6d5ac8c5d9bb4c9cb2fd8b8f2d9f9c30
                ReplacedByTokenId: null
                IpAddress: 192.168.0.24
                UserAgent: Mozilla/5.0 (Macintosh)
                CreatedAt: '2025-11-10T10:30:00Z'
                ExpiresAt: '2025-11-24T10:30:00Z'
                RevokedAt: null
                RevocationReason: null
        '400':
          $ref: '#/components/responses/ValidationProblem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/UserSession/{id}:
    parameters:
      - $ref: '#/components/parameters/AuthorizationHeader'
      - name: id
        in: path
        required: true
        description: Identifiant de la session.
        schema:
          type: string
          format: uuid
    get:
      tags:
        - UserSession
      summary: Consulter une session
      description: >
        Retourne la session correspondant à l'identifiant fourni.
      operationId: UserSession_GetSession
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Session trouvée.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSessionDto'
              example:
                Id: 4c0e1a77-00a9-45e0-89d2-7a23798b5df5
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                TokenId: 6d5ac8c5d9bb4c9cb2fd8b8f2d9f9c30
                ReplacedByTokenId: null
                IpAddress: 192.168.0.24
                UserAgent: Mozilla/5.0 (Macintosh)
                CreatedAt: '2025-11-10T10:30:00Z'
                ExpiresAt: '2025-11-24T10:30:00Z'
                RevokedAt: null
                RevocationReason: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    patch:
      tags:
        - UserSession
      summary: Mettre à jour partiellement une session
      description: >
        Met à jour les attributs d'une session. Vérifie l'unicité des identifiants de jeton et l'existence
        de l'utilisateur. Accessible aux rôles OWNER, ADMIN, MEMBER.
      operationId: UserSession_UpdateSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserSessionDto'
            example:
              TokenId: 7e6bcb2d2a1b4101a7a97bdf45fca908
              ExpiresAt: '2025-11-30T10:30:00Z'
              UserAgent: Mozilla/5.0 (Macintosh; ARM64)
      responses:
        '200':
          description: Session mise à jour.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSessionDto'
              example:
                Id: 4c0e1a77-00a9-45e0-89d2-7a23798b5df5
                UserId: 9368b7a9-1e6c-4f7c-91fb-0afc8dae6fa2
                TokenId: 7e6bcb2d2a1b4101a7a97bdf45fca908
                ReplacedByTokenId: null
                IpAddress: 192.168.0.24
                UserAgent: Mozilla/5.0 (Macintosh; ARM64)
                CreatedAt: '2025-11-10T10:30:00Z'
                ExpiresAt: '2025-11-30T10:30:00Z'
                RevokedAt: null
                RevocationReason: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags:
        - UserSession
      summary: Supprimer une session
      description: >
        Supprime définitivement la session spécifiée.
      operationId: UserSession_DeleteSession
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Session supprimée.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Jeton d'authentification JWT au format `Authorization: Bearer <token>`.
  parameters:
    AuthorizationHeader:
      name: Authorization
      in: header
      required: true
      description: Jeton JWT au format `Bearer <token>`. Obligatoire pour toutes les routes protégées.
      schema:
        type: string
        pattern: '^Bearer\s.+'
  responses:
    BadRequest:
      description: Requête invalide ou données incohérentes (ValidationException, erreurs fonctionnelles).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 400
            title: Erreur de validation
            detail: Client associé introuvable ou supprimé.
            instance: /api/User
            type: https://httpstatuses.io/400
    ValidationProblem:
      description: Erreurs de validation du modèle (ModelState invalide).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationProblemDetails'
          example:
            status: 400
            title: Une ou plusieurs erreurs de validation se sont produites.
            detail: Voir la propriété Errors pour plus de détails.
            instance: /api/UserSession
            type: https://httpstatuses.io/400
            errors:
              ExpiresAt:
                - La date d'expiration doit être dans le futur.
    Unauthorized:
      description: Jeton JWT absent, expiré ou utilisateur inactif (UnauthorizedException).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 401
            title: Accès non autorisé
            detail: Jeton invalide ou expiré.
            instance: /api/Client
            type: https://httpstatuses.io/401
    Forbidden:
      description: Accès refusé pour le rôle courant.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 403
            title: Accès refusé
            detail: Le rôle authentifié n'autorise pas cette opération.
            instance: /api/Client
            type: https://httpstatuses.io/403
    NotFound:
      description: Ressource introuvable (NotFoundException).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 404
            title: Ressource introuvable
            detail: Client introuvable.
            instance: /api/Client/7f1b1f0a-1cfa-4bfc-9707-90262c45dd61
            type: https://httpstatuses.io/404
    Conflict:
      description: Conflit de ressource (DuplicateResourceException).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 409
            title: Conflit de ressource
            detail: Une préférence utilisateur existe déjà pour cet utilisateur.
            instance: /api/UserPreference
            type: https://httpstatuses.io/409
    ServerError:
      description: Erreur interne ou base de données (DatabaseException, erreur inattendue).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            status: 500
            title: Erreur interne du serveur
            detail: Échec de la création de la session.
            instance: /api/Auth/login
            type: https://httpstatuses.io/500
  schemas:
    ClientDto:
      type: object
      required:
        - Id
        - Name
        - Type
        - Status
        - CreatedAt
        - UpdatedAt
      properties:
        Id:
          type: string
          format: uuid
        Name:
          type: string
          maxLength: 100
        Type:
          $ref: '#/components/schemas/ClientType'
        Status:
          $ref: '#/components/schemas/ClientStatus'
        CreatedAt:
          type: string
          format: date-time
        UpdatedAt:
          type: string
          format: date-time
        DeletedAt:
          type: string
          format: date-time
          nullable: true
    CreateClientDto:
      type: object
      required:
        - Name
        - Type
        - Status
      properties:
        Name:
          type: string
          maxLength: 100
        Type:
          $ref: '#/components/schemas/ClientType'
        Status:
          $ref: '#/components/schemas/ClientStatus'
    UpdateClientDto:
      type: object
      properties:
        Name:
          type: string
          maxLength: 100
        Type:
          $ref: '#/components/schemas/ClientType'
          nullable: true
        Status:
          $ref: '#/components/schemas/ClientStatus'
          nullable: true
    UserDto:
      type: object
      required:
        - Id
        - ClientId
        - Email
        - FirstName
        - LastName
        - Role
        - Status
        - CreatedAt
        - UpdatedAt
      properties:
        Id:
          type: string
          format: uuid
        ClientId:
          type: string
          format: uuid
        Email:
          type: string
          format: email
          maxLength: 255
        FirstName:
          type: string
          maxLength: 100
        LastName:
          type: string
          maxLength: 100
        Role:
          $ref: '#/components/schemas/UserRole'
        Status:
          $ref: '#/components/schemas/UserStatus'
        LastLoginAt:
          type: string
          format: date-time
          nullable: true
        CreatedAt:
          type: string
          format: date-time
        UpdatedAt:
          type: string
          format: date-time
        DeletedAt:
          type: string
          format: date-time
          nullable: true
    CreateUserDto:
      type: object
      required:
        - ClientId
        - Email
        - PasswordHash
        - FirstName
        - LastName
        - Role
        - Status
      properties:
        ClientId:
          type: string
          format: uuid
        Email:
          type: string
          format: email
          maxLength: 255
        PasswordHash:
          type: string
          description: Mot de passe en clair (sera haché côté serveur).
          maxLength: 255
        FirstName:
          type: string
          maxLength: 100
        LastName:
          type: string
          maxLength: 100
        Role:
          $ref: '#/components/schemas/UserRole'
        Status:
          $ref: '#/components/schemas/UserStatus'
    UpdateUserDto:
      type: object
      properties:
        ClientId:
          type: string
          format: uuid
          nullable: true
        Email:
          type: string
          format: email
          maxLength: 255
        PasswordHash:
          type: string
          maxLength: 255
        FirstName:
          type: string
          maxLength: 100
        LastName:
          type: string
          maxLength: 100
        Role:
          $ref: '#/components/schemas/UserRole'
          nullable: true
        Status:
          $ref: '#/components/schemas/UserStatus'
          nullable: true
        LastLoginAt:
          type: string
          format: date-time
          nullable: true
        DeletedAt:
          type: string
          format: date-time
          nullable: true
    UserPreferenceDto:
      type: object
      required:
        - Id
        - UserId
        - Theme
        - Language
        - NotificationsEnabled
        - CreatedAt
        - UpdatedAt
      properties:
        Id:
          type: string
          format: uuid
        UserId:
          type: string
          format: uuid
        Theme:
          $ref: '#/components/schemas/Theme'
        Language:
          type: string
          maxLength: 255
        NotificationsEnabled:
          type: boolean
        CreatedAt:
          type: string
          format: date-time
        UpdatedAt:
          type: string
          format: date-time
    CreateUserPreferenceDto:
      type: object
      required:
        - UserId
        - Theme
        - Language
        - NotificationsEnabled
      properties:
        UserId:
          type: string
          format: uuid
        Theme:
          $ref: '#/components/schemas/Theme'
        Language:
          type: string
          maxLength: 255
        NotificationsEnabled:
          type: boolean
    UpdateUserPreferenceDto:
      type: object
      properties:
        Theme:
          $ref: '#/components/schemas/Theme'
          nullable: true
        Language:
          type: string
          maxLength: 255
        NotificationsEnabled:
          type: boolean
          nullable: true
    UserSessionDto:
      type: object
      required:
        - Id
        - UserId
        - TokenId
        - IpAddress
        - UserAgent
        - CreatedAt
        - ExpiresAt
      properties:
        Id:
          type: string
          format: uuid
        UserId:
          type: string
          format: uuid
        TokenId:
          type: string
          maxLength: 255
        ReplacedByTokenId:
          type: string
          maxLength: 255
          nullable: true
        IpAddress:
          type: string
          maxLength: 255
        UserAgent:
          type: string
          maxLength: 500
        CreatedAt:
          type: string
          format: date-time
        ExpiresAt:
          type: string
          format: date-time
        RevokedAt:
          type: string
          format: date-time
          nullable: true
        RevocationReason:
          type: string
          maxLength: 255
          nullable: true
    CreateUserSessionDto:
      type: object
      required:
        - UserId
        - TokenId
        - TokenHash
        - IpAddress
        - UserAgent
        - ExpiresAt
      properties:
        UserId:
          type: string
          format: uuid
        TokenId:
          type: string
          maxLength: 255
        TokenHash:
          type: string
          maxLength: 128
        IpAddress:
          type: string
          maxLength: 255
        UserAgent:
          type: string
          maxLength: 255
        ExpiresAt:
          type: string
          format: date-time
    UpdateUserSessionDto:
      type: object
      properties:
        UserId:
          type: string
          format: uuid
          nullable: true
        TokenId:
          type: string
          maxLength: 255
        TokenHash:
          type: string
          maxLength: 128
        IpAddress:
          type: string
          maxLength: 255
        UserAgent:
          type: string
          maxLength: 255
        ExpiresAt:
          type: string
          format: date-time
          nullable: true
    LoginRequestDto:
      type: object
      required:
        - Email
        - Password
      properties:
        Email:
          type: string
          format: email
          maxLength: 255
        Password:
          type: string
          maxLength: 255
    LogoutRequestDto:
      type: object
      required:
        - RefreshToken
      properties:
        RefreshToken:
          type: string
          minLength: 32
        RevokeAllSessions:
          type: boolean
          default: false
    RefreshTokenRequestDto:
      type: object
      required:
        - RefreshToken
      properties:
        RefreshToken:
          type: string
          minLength: 32
    TokenPairResponseDto:
      type: object
      required:
        - AccessToken
        - RefreshToken
        - ExpiresAt
        - RefreshExpiresAt
      properties:
        AccessToken:
          type: string
        RefreshToken:
          type: string
        ExpiresAt:
          type: string
          format: date-time
        RefreshExpiresAt:
          type: string
          format: date-time
    LoginResponseDto:
      allOf:
        - $ref: '#/components/schemas/TokenPairResponseDto'
      description: Réponse à l'authentification contenant le couple de jetons.
    ProblemDetails:
      type: object
      description: >
        Format d'erreur standard RFC 7807 utilisé pour les exceptions métiers et techniques.
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
          format: int32
        detail:
          type: string
        instance:
          type: string
        traceId:
          type: string
          description: Identifiant de corrélation (si activé).
    ValidationProblemDetails:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          properties:
            errors:
              type: object
              additionalProperties:
                type: array
                items:
                  type: string
          required:
            - errors
    ClientType:
      type: string
      enum:
        - INDIVIDUAL
        - COMPANY
    ClientStatus:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
        - SUSPENDED
        - PENDING
    UserRole:
      type: string
      enum:
        - OWNER
        - ADMIN
        - MEMBER
        - SERVICE
    UserStatus:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
        - SUSPENDED
        - PENDING
    Theme:
      type: string
      enum:
        - LIGHT
        - DARK
        - SYSTEM

